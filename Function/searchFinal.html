<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>查询周边</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f4f4f9;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            margin: 0;
        }
        #network {
            width: 80%;
            height: 600px;
            border: 1px solid #ccc;
            margin: 20px auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        #results, .selector-wrapper {
            width: 80%;
            margin: 20px auto;
            background: white;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        select, input {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            cursor: pointer;
            background-color: #fafafa;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #0056b3;
            box-shadow: 0 0 0 3px rgba(0, 84, 179, 0.2);
        }
        select[multiple] {
            height: auto;
            overflow-y: auto;
            background-color: #ffffff;
        }
        option {
            padding: 8px 12px;
            background-color: #f9f9f9;
            border-bottom: 1px solid #eee;
        }
        option:hover {
            background-color: #eef4ff;
        }
        option:checked, option:selected {
            background-color: #dae8ff;
            color: #333;
        }
        button {
            width: 100%;
            background-color: #0056b3;
            color: white;
            padding: 10px;
            margin-top: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #004494;
        }
        .highlighted {
            font-weight: bold;
            color: #d10000;
            background-color: #ffd2d2;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(209,0,0,0.2);
            text-align: center;
        }
        h1, h2 {
            text-align: center;
            color: #333;
        }
        h2 {
            margin-top: 20px;
            color: #0056b3;
        }
        .result-item {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .no-results {
            text-align: center;
            color: #999;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>查询周边</h1>
        <div class="selector-wrapper">
            <input type="text" v-model="graphFilter" placeholder="请输入学校或景点名称...">
            <select v-model="selectedGraph" @change="loadGraph">
                <option v-for="graph in filteredGraphs" :value="graph">{{ graph }}</option>
            </select>
        </div>
        <div class="selector-wrapper">
            <input type="text" v-model="nodeSearch" placeholder="请输入设施类别...">
            <select v-model="selectedNode" @change="selectNodeFromDropdown">
                <option v-for="node in filteredNodes" :value="node">{{ node }}</option>
            </select>
        </div>
        <p class="highlighted">已选中：{{ selectedNode || '请选中地点以查询周边' }}</p>
        <div id="network"></div>
        <input type="number" v-model.number="maxDistance" placeholder="请输入中心辐射距离">
        <button @click="search">搜索</button>
        <p class="highlighted">您可以按地点类型对结果进行筛选：</p>
        <div class="selector-wrapper">
            <select multiple v-model="selectedTypes">
                <option value="">不筛选</option>
                <option v-for="type in allNodeTypes" :value="type">{{ type }}</option>
            </select>
        </div>
        <div id="results">
            <h2>周边地点结果</h2>
            <div v-if="filteredResults.length">
                <div v-for="(result, index) in filteredResults" :key="result.name" class="result-item">
                    {{ index + 1 }}. 设施类型：{{ result.type }}，地点名称：{{ result.name }}——距离：{{ result.distance }}米
                </div>
            </div>
            <div v-else class="no-results">
                在当前条件下没有结果
            </div>
        </div>
    </div>

    <script type="module">
    import { createApp, ref, computed } from 'https://cdn.jsdelivr.net/npm/vue@3/dist/vue.esm-browser.js';
    import graph1 from './graph1.js';
    import graph2 from './graph2.js';
    import graph3 from './graph3.js';
    import graph4 from './graph4.js';
    import graph5 from './graph5.js';

    const graphs = { graph1, graph2, graph3, graph4, graph5 };

    createApp({
        setup() {
            const graphNames = ['graph1', 'graph2', 'graph3', 'graph4', 'graph5'];
            const selectedGraph = ref('graph1');
            const graphFilter = ref('');
            const nodeSearch = ref('');
            const selectedNode = ref('');
            const network = ref(null);
            const maxDistance = ref(100);
            const results = ref([]);
            const selectedTypes = ref([]);

            const filteredGraphs = computed(() => {
                return graphNames.filter(g => g.toLowerCase().includes(graphFilter.value.toLowerCase()));
            });

            const filteredNodes = computed(() => {
                const nodes = graphs[selectedGraph.value];
                return nodeSearch.value ? Object.keys(nodes).filter(node => node.toLowerCase().includes(nodeSearch.value.toLowerCase())) : Object.keys(nodes);
            });

            const allNodeTypes = computed(() => {
                const types = new Set();
                Object.values(graphs[selectedGraph.value]).forEach(node => {
                    types.add(node.node_type); // 假设节点的类型信息存储在 node_type 属性中
                });
                return [...types];
            });

            const filteredResults = computed(() => {
                if (!selectedTypes.value.length || selectedTypes.value.includes("")) {
                    return results.value;
                }
                return results.value.filter(result => selectedTypes.value.includes(result.type));
            });

            function loadGraph() {
                const nodes = [];
                const edges = [];
                const edgeSet = new Set();  // To prevent adding edges twice
                const graph = graphs[selectedGraph.value];
                for (let node in graph) {
                    nodes.push({ id: node, label: node, group: graph[node].node_category });
                    graph[node].edges.forEach(edge => {
                        const edgeId = node < edge.node ? node + '-' + edge.node : edge.node + '-' + node;
                        if (!edgeSet.has(edgeId)) {
                            edges.push({
                                from: node,
                                to: edge.node,
                                label: String(edge.distance),
                                color: edge.bike_flag ? 'blue' : 'red'
                            });
                            edgeSet.add(edgeId);
                        }
                    });
                }
                const container = document.getElementById('network');
                const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
                const options = {};
                if (network.value) {
                    network.value.destroy();
                }
                network.value = new vis.Network(container, data, options);
                network.value.on("selectNode", function (params) {
                    if (params.nodes.length > 0) {
                        selectedNode.value = params.nodes[0];
                    }
                });
            }

            function filterNodes() {
                selectedNode.value = '';
            }

            function selectNodeFromDropdown() {
                if (network.value && selectedNode.value) {
                    const nodeExists = network.value.body.data.nodes.get(selectedNode.value);
                    if (nodeExists) {
                        network.value.selectNodes([selectedNode.value]);
                        network.value.redraw();
                    } else {
                        console.error("Node does not exist: ", selectedNode.value);
                    }
                } else {
                    console.error("Network graph is not initialized or selected node is undefined.");
                }
            }

            function search() {
                results.value = [];
                const targetNode = graphs[selectedGraph.value][selectedNode.value];
                if (targetNode) {
                    let nodeDistances = [];
                    for (let node in graphs[selectedGraph.value]) {
                        if (node !== selectedNode.value) {
                            graphs[selectedGraph.value][node].edges.forEach(edge => {
                                if (edge.node === selectedNode.value && edge.distance <= maxDistance.value) {
                                    nodeDistances.push({
                                        name: node,
                                        distance: edge.distance,
                                        type: graphs[selectedGraph.value][node].node_type // 假设节点的类型信息存储在 node_type 属性中
                                    });
                                }
                            });
                        }
                    }
                    nodeDistances.sort((a, b) => a.distance - b.distance);
                    results.value = nodeDistances.length > 0 ? nodeDistances : [{ name: "No nodes within the specified range.", distance: "-", type: "N/A" }];
                }
            }

            return { selectedGraph, graphFilter, filteredGraphs, network, maxDistance, results, search, filteredNodes, nodeSearch, selectedNode, allNodeTypes, filteredResults, loadGraph, filterNodes, selectNodeFromDropdown, selectedTypes };
        }
    }).mount('#app');
    </script>
</body>
</html>
